<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách công việc</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>Danh sách công việc</h2>

        <!-- Thêm ô tìm kiếm và nút thêm mới -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="search-bar">
                <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm công việc...">
            </div>
            <button id="addTask" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">Thêm mới</button>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="assigned-by-me-tab" data-bs-toggle="tab" href="#assigned-by-me" role="tab" aria-controls="assigned-by-me" aria-selected="true">Tôi Giao</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="needs-to-do-tab" data-bs-toggle="tab" href="#needs-to-do" role="tab" aria-controls="needs-to-do" aria-selected="false">Cần Làm</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3" id="myTabContent">
            <!-- Tôi Giao -->
            <div class="tab-pane fade show active" id="assigned-by-me" role="tabpanel" aria-labelledby="assigned-by-me-tab">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Mô tả</th>
                            <th>Ngày giao việc</th>
                            <th>Ngày hoàn thành</th>
                            <th>File đính kèm</th>
                            <th>Trạng thái</th>
                            <th>Người làm</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="assignedByMeTableBody">
                        <!-- Dữ liệu sẽ được thêm động từ JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Cần Làm -->
          
            <div class="tab-pane fade" id="needs-to-do" role="tabpanel" aria-labelledby="needs-to-do-tab">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID Công Việc</th>
                            <th>Mô Tả</th>
                            <th>Ngày giao</th>
                            <th>Ngày phải hoàn thành</th>
                            <th>File đính kèm</th>
                            <th>Trạng Thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm động từ JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Thêm Mới Công Việc -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">Thêm Mới Công Việc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">Nội dung công việc</label>
                            <input type="text" class="form-control" id="taskDescription" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskAttachment" class="form-label">Tệp đính kèm</label>
                            <input type="file" class="form-control" id="taskAttachment">
                        </div>
                        <div class="mb-3">
                            <label for="taskDueDate" class="form-label">Ngày hoàn thành</label>
                            <input type="date" class="form-control" id="taskDueDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="saveTaskButton" onclick="saveTask()">Lưu công việc</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa công việc -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Chi Tiết Công Việc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="NoiDung" class="form-label">Mô Tả Công Việc</label>
                        <textarea id="NoiDung" class="form-control" rows="3"></textarea>
                    </div>
                    <!-- Ô tìm kiếm và danh sách người làm -->
                    <div class="mb-3">
                        <label for="searchAssignees" class="form-label">Tìm kiếm người thực hiện</label>
                        <input type="text" id="searchAssignees" class="form-control search-box" placeholder="Nhập tên người thực hiện">
                        <label for="taskAssignees" class="form-label">Người Thực Hiện</label>
                        <div id="NguoiLam">
                          
                        </div>
                    </div>
                 
                    <div class="mb-3">
                        <label for="NgayXong" class="form-label">Ngày Hết Hạn</label>
                        <input type="date" id="NgayXong" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="saveChanges">Lưu Thay Đổi</button>
                </div>
            </div>
        </div>
    </div>




    <script>
        $(document).ready(function () {
            LoadTask();
        });

        function LoadTask() {
            $.ajax({
                url: '@Url.Action("ListTask", "Work")',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var tbody = $('#assignedByMeTableBody');
                    tbody.empty();

                    $.each(data, function (index, work) {
                        var row = $('<tr>');

                        row.append($('<td>').text(work.id));
                        row.append($('<td>').text(work.noiDung));
                        var ngayGiaoFormatted = new Date(work.ngayGiao).toLocaleDateString('vi-VN');
                        row.append($('<td>').text(ngayGiaoFormatted));
                        var ngayXongFormatted = new Date(work.ngayXong).toLocaleDateString('vi-VN');
                        row.append($('<td>').text(ngayXongFormatted));
                        row.append($('<td>').text(work.tepDinhKemPath));
                        var statusText = work.status == 0 ? "Chưa hoàn thành" : "Đã hoàn thành";
                        row.append($('<td>').text(statusText));
                        row.append($('<td>').text(work.assigneeNames));

                        var actionButton = $('<button class="btn btn-primary">');
                        actionButton.attr('data-id', work.id);                    
                            actionButton.text('Sửa').attr('data-action', 'edit').off('click').on('click', function () {
                                editTask(work.id, work.noiDung);
                            });
                        

                        row.append($('<td>').append(actionButton));
                        tbody.append(row);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching data: " + error);
                }
            });
        }
        //Thêm việc
        function saveTask() {
            var des = $('#taskDescription').val();
            var teppath = $('#taskAttachment').val();
            var ngayxong = $('#taskDueDate').val();
            if (confirm("Bạn có chắc chắn muốn thêm công việc này?")) {
                $.ajax({
                    url: '@Url.Action("AddWork", "Work")',
                    type: 'POST',
                    data: JSON.stringify({
                        NoiDung: des,
                        NgayXong: ngayxong,
                        TepDinhKemPath: teppath
                    }),
                    contentType: 'application/json',
                    success: function () {
                        alert("Công việc đã được thêm thành công!");
                        $('#addTaskModal').modal('hide');
                        LoadTask();
                    },
                    error: function (xhr, status, error) {
                        alert("Đã xảy ra lỗi: " + xhr.responseText);
                    }
                });
            } else {
                console.log('Thêm công việc bị hủy');
            }
        }

    //Giao cho người làm
        function editTask(taskId, noidung) {
            $('#taskModal').modal('show');
            $('#NoiDung').val(noidung);
           
            $.ajax({
                url: '@Url.Action("GetNguoiLam", "Work")',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var tableHtml = '<table class="table table-striped">';
                    tableHtml += '<thead><tr><th>Chọn</th><th>Tên</th></tr></thead>';
                    tableHtml += '<tbody>';

                    data.forEach(function (acc) {
                        tableHtml += `<tr>
                                        <td><input type="checkbox" class="form-check-input assignee-checkbox" data-id="${acc.id}"></td>
                                        <td>${acc.name}</td>
                                    </tr>`;
                    });

                    tableHtml += '</tbody></table>';
                    $('#NguoiLam').html(tableHtml);
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching assignees: " + error);
                }
            });

            //Ấn nút lưu
            $('#saveChanges').on('click', function () {

                
                var noidung = $('#NoiDung').val();
                var NguoiChon = [];
                $('.assignee-checkbox:checked').each(function () {
                    NguoiChon.push($(this).data('id'));
                });
              
            });
        }
        //
        $('#searchAssignees').on('input', function () {
            var searchValue = $(this).val().toLowerCase();
            $('#NguoiLam .table tbody tr').each(function () {
                var rowText = $(this).text().toLowerCase();
                $(this).toggle(rowText.indexOf(searchValue) > -1);
            });
        });

        $('#searchInput').on('input', function () {
            var query = $(this).val().toLowerCase();

            $('#assignedByMeTableBody tr').each(function () {
                var description = $(this).find('td').eq(1).text().toLowerCase();
                $(this).toggle(description.includes(query));
            });

            $('#needsToDoTableBody tr').each(function () {
                var description = $(this).find('td').eq(1).text().toLowerCase();
                $(this).toggle(description.includes(query));
            });
        });
    </script>

</body>
</html>
