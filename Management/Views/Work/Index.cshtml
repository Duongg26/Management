<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách công việc</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <style>
        /* CSS tùy chỉnh để tạo dòng kẻ cho bảng */
        .table-bordered {
            border: 1px solid #dee2e6;
        }

            .table-bordered th, .table-bordered td {
                border: 1px solid #dee2e6;
            }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Danh sách công việc</h2>

        <!-- Thêm ô tìm kiếm và nút thêm mới -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="search-bar">
                <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm công việc...">
            </div>
            <button id="addTask" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal" onclick="editTask()">Thêm mới</button>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="assigned-by-me-tab" data-bs-toggle="tab" href="#assigned-by-me" role="tab" aria-controls="assigned-by-me" aria-selected="true">Tôi Giao</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="needs-to-do-tab" data-bs-toggle="tab" href="#needs-to-do" role="tab" aria-controls="needs-to-do" aria-selected="false">Cần Làm</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3" id="myTabContent">
            <!-- Tôi Giao -->
            <div class="tab-pane fade show active" id="assigned-by-me" role="tabpanel" aria-labelledby="assigned-by-me-tab">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Mô tả</th>
                            <th>Ngày giao việc</th>
                            <th>Ngày hoàn thành</th>
                            <th>File đính kèm</th>
                            <th>Trạng thái</th>
                            <th>Người làm</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="assignedByMeTableBody">
                        <!-- Dữ liệu sẽ được thêm động từ JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Cần Làm -->
          
            <div class="tab-pane fade" id="needs-to-do" role="tabpanel" aria-labelledby="needs-to-do-tab">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Mô Tả</th>
                            <th>Ngày giao</th>
                            <th>Ngày phải hoàn thành</th>
                            <th>File đính kèm</th>
                            <th>Trạng Thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="needs-to-do-table-body">
                    
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Modal chỉnh sửa công việc -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Chi Tiết Công Việc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="TenCongViec" class="form-label">Tên Công Việc</label>
                        <input type="text" id="TenCongViec" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="NoiDung" class="form-label">Mô Tả Công Việc</label>
                        <textarea id="NoiDung" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="deadline" class="form-label">Ngày Hết Hạn</label>
                        <input type="date" id="HanCv" class="form-control">
                    </div>
                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="taskTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="assignees-tab" data-bs-toggle="tab" data-bs-target="#assignees" type="button" role="tab" aria-controls="assignees" aria-selected="true">Người Làm</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">Tệp</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="taskTabContent">
                        <!-- Người Làm Tab -->
                        <div class="tab-pane fade show active" id="assignees" role="tabpanel" aria-labelledby="assignees-tab">
                            <div class="mt-3">
                                <label for="searchAssignees" class="form-label">Tìm kiếm người thực hiện</label>
                                <input type="text" id="searchAssignees" class="form-control search-box" placeholder="Nhập tên người thực hiện">
                                <div id="NguoiLamContainer" style="max-height: 300px; overflow-y: auto;" class="mt-2">
                                </div>
                                <button type="button" class="btn btn-danger mt-2" id="clearCheckedAssignees">Hủy Tất Cả Người Đã Chọn</button>
                            </div>
                                    <label for="taskAssignees" class="form-label">Người Thực Hiện</label>
                                    <div id="NguoiLam">
                                        <!-- Bảng sẽ được chèn vào đây -->
                                   
                            </div>
                        </div>
                        <!-- Tệp Tab -->
                        <div class="tab-pane fade" id="files" role="tabpanel" aria-labelledby="files-tab">
                            <div class="mt-3">
                                <label for="taskFiles" class="form-label">Tải Lên Tệp</label>
                                <input type="file" id="taskFiles" class="form-control" multiple>
                            </div>
                            <div id="uploadedFiles" class="mt-2">
                                <!-- Danh sách các tệp đã tải lên sẽ hiển thị ở đây -->
                            </div>
                            <button type="button" class="btn btn-danger mt-2" id="clearFiles">Hủy Tất Cả Tệp</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="saveChanges">Lưu Thay Đổi</button>
                </div>
            </div>
        </div>
    </div>
    <!--  modal kiểm tra -->
    <div class="modal fade" id="KiemTraTask" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">Chi tiết</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                  
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Tên</th>
                                <th>Trạng Thái</th>
                            </tr>
                        </thead>
                        <tbody id="modalBody">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    <!--  modal chi tiết -->
    <div class="modal fade" id="ChiTietTask" tabindex="-1" role="dialog" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Chi tiết nhiệm vụ</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="taskContent">Nội dung:</label>
                        <p id="NoiDungTask"></p>
                    </div>
                    <div class="form-group">
                        <label for="taskParticipants">Người chung nhóm:</label>
                        <ul id="NguoiLamTask" class="list-group">
                        </ul>
                    </div>
                    <div id="assignSection" style="display: none;">
                        <div class="form-group">
                            <label for="selectPerson">Chọn người để chuyển tiếp:</label>
                            <select id="selectPerson" class="form-control">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="ChuyenTiepNL">Chuyển tiếp</button>
                    <button type="button" class="btn btn-success" id="HoanThanh">Hoàn thành</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        $(document).ready(function () {
            LoadTask();
        });

        function LoadTask() {
            $.ajax({
                url: '@Url.Action("ListTask", "Work")',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var tbody = $('#assignedByMeTableBody');
                    tbody.empty();


                    $.each(data, function (index, work) {
                        var row = $('<tr>');
                        var files = work.dsTep.split(',');
                        var tdFiles = $('<td>');
                        files.forEach(function (file) {
                            tdFiles.append($('<div>').text(file));
                        });
                        row.append($('<td>').text(work.id));
                        row.append($('<td>').text(work.tenCV));
                        var ngayGiaoFormatted = new Date(work.ngayGiao).toLocaleDateString('vi-VN');
                        row.append($('<td>').text(ngayGiaoFormatted));
                        var ngayXongFormatted = new Date(work.ngayXong).toLocaleDateString('vi-VN');
                        row.append($('<td>').text(ngayXongFormatted));
                        row.append(tdFiles);
                        var statusText = work.status === 0 ? "Chưa hoàn thành" : "Đã hoàn thành";
                        row.append($('<td>').text(statusText));
                        row.append($('<td>').text(work.assigneeNames));

                      
                        var editButton = $('<button class="btn btn-primary">');
                        editButton.text('Sửa').attr('data-action', 'edit');
                        editButton.on('click', function () {
                            editTask(work.id, work.noiDung, work.ngayXong, work.tenCV, work.dsTep);
                        });

                        
                        var checkButton = $('<button class="btn btn-warning">');
                        checkButton.text('Kiểm tra').attr('data-action', 'check');
                        checkButton.on('click', function () {
                            checkTask(work.id); 
                        });

                     
                        var buttonContainer = $('<td class="button-container">');
                        buttonContainer.append(editButton).append(checkButton);

                      
                        row.append(buttonContainer);

                     
                        tbody.append(row);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching data: " + error);
                }
            });
        }
        function checkTask(IdCv) {
            
            $('#KiemTraTask').modal('show');
            $.ajax({
                url: '@Url.Action("Kiemtra", "Work")', 
                type: 'GET',
                dataType: 'json',
                data: { id: IdCv }, 
                success: function (response) {
                    var tbody = $('#modalBody');
                    tbody.empty(); 
                    response.forEach(function (item) {
                        console.log(item);
                        switch (item.status) {
                            case 0:
                                statusText = 'Chưa hoàn thành';
                                break;
                            case 1:
                                statusText = 'Hoàn thành';
                                break;
                            case 2:
                                statusText = 'Đã chuyển việc';
                                break;
                            case 3:
                                statusText = 'Người nhận việc';
                                break;
                        }

                        var row = '<tr><td>' + item.name + '</td><td>' + statusText + '</td></tr>';
                        tbody.append(row);
                    });
                },
                error: function (xhr, status, error) {
                    console.error('AJAX Error:', status, error);
                }
            });
          
        }

        // -----------------------------------------------------------------------------------------------------
        function editTask(taskId, noiDung,ngayXong,tenCv,dsTep) {
            $('#taskModal').modal('show');
            $('#NoiDung').val(noiDung);
            $('#HanCv').val(ngayXong);
            $('#TenCongViec').val(tenCv);
            var files = dsTep.split(',');
            var uploadedFilesDiv = $('#uploadedFiles');
            uploadedFilesDiv.empty(); 

            if (files.length > 0) {
                $.each(files, function (index, file) {
                    uploadedFilesDiv.append(
                        $('<div>').text(file)
                    );
                });
            } else {
                uploadedFilesDiv.append(
                    $('<div>').text('Chưa có tệp nào được tải lên.')
                );
            }
        
          

            $.ajax({
                url: '@Url.Action("GetNguoiLam", "Work")',
                type: 'GET',
                data: { idTask: taskId },
                dataType: 'json',
                success: function (data) {
                    var assignedIds = data.assignedIds;
                    var accounts = data.accounts;

                    var tableHtml = '<table class="table table-striped">';
                    tableHtml += '<thead><tr><th>Chọn</th><th>Tên</th></tr></thead>';
                    tableHtml += '<tbody>';

                    accounts.forEach(function (acc) {
                        var isChecked = assignedIds.includes(acc.id) ? 'checked' : '';
                        tableHtml += `<tr>
                                            <td><input type="checkbox" class="form-check-input assignee-checkbox" data-id="${acc.id}" ${isChecked}></td>
                                            <td>${acc.name}</td>
                                          </tr>`;
                    });

                    tableHtml += '</tbody></table>';
                    $('#NguoiLam').html(tableHtml);
                  
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching assignees: " + error);
                }
            });

            // Lưu thay đổi
            $('#saveChanges').off('click').on('click', function () {
                // Hiển thị hộp thoại xác nhận
                var isConfirmed = confirm("Bạn có chắc chắn muốn lưu các thay đổi không?");

                if (isConfirmed) {
                    var NoiDung = $('#NoiDung').val();
                    var HanCv = $('#HanCv').val();
                    var TenCv = $('#TenCongViec').val();
                    var NguoiChon = [];
                    $('.assignee-checkbox:checked').each(function () {
                        NguoiChon.push($(this).data('id'));
                    });

                    var fileInput = document.getElementById('taskFiles');
                    var files = fileInput.files;
                    var tep = [];
                    for (var i = 0; i < files.length; i++) {
                        tep.push(files[i].name);
                    }

                    var url = taskId == null ? '@Url.Action("AddWork", "Work")' : '@Url.Action("UpdateWork", "Work")';

                    var data = {
                        Id: taskId,
                        TenCV: TenCv,
                        NoiDung: NoiDung,
                        NgayXong: HanCv,
                        DsNguoiLam: NguoiChon.join(','),
                        DsTep: tep.join(',')
                    };

                    $.ajax({
                        url: url,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data), 
                        success: function (response) {
                            alert("Cập nhật công việc thành công");
                            $('#taskModal').modal('hide');
                            LoadTask();
                        },
                        error: function (xhr, status, error) {
                            console.error("Error saving changes: " + error);
                        }
                    });
                } else {
                    console.log("Người dùng đã hủy hành động.");
                }
            });


          
          

            $('#taskFiles').off('change').on('change', function () {
                var uploadedFilesContainer = document.getElementById('uploadedFiles');
                uploadedFilesContainer.innerHTML = '';
                var files = this.files;
                var fileNames = [];
                for (var i = 0; i < files.length; i++) {
                    var listItem = document.createElement('div');
                    listItem.textContent = files[i].name;
                    uploadedFilesContainer.appendChild(listItem);
                    fileNames.push(files[i].name);
                }
            });
        }
        $(document).ready(function () {
            LoadTask();
            LoadNeedsToDoTasks(); // Gọi hàm này để tải dữ liệu cho tab "Cần Làm"
        });

        $('#needs-to-do-tab').on('shown.bs.tab', function () {
            LoadNeedsToDoTasks(); 
        });

        //Công việc cần làm
        function LoadNeedsToDoTasks() {
            $.ajax({
                url: '@Url.Action("CanLam", "Work")',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    var tbody = $('#needs-to-do-table-body');
                    tbody.empty();

                    if (response.Message) {
                        tbody.append($('<tr>').append($('<td colspan="7">').text(response.Message)));
                        return;
                    }

                    $.each(response, function (index, task) {
                        var row = $('<tr>');
                        console.log(task);

                        row.append($('<td>').text(task.id));
                        row.append($('<td>').text(task.tenCV));
                        row.append($('<td>').text(new Date(task.ngayGiao).toLocaleDateString('vi-VN')));
                        row.append($('<td>').text(new Date(task.ngayXong).toLocaleDateString('vi-VN')));

                        var fileTd = $('<td>');
                        var files = task.dsTep ? task.dsTep.split(',') : [];
                        $.each(files, function (i, file) {
                            fileTd.append($('<div>').text(file));
                        });
                        row.append(fileTd);

                        var statusText = task.trangThai ? "Đã hoàn thành" : "Chưa hoàn thành";
                        row.append($('<td>').text(statusText));

                        var actionButton = $('<button class="btn btn-primary">');
                        actionButton.text('Chi tiết').attr('data-id', task.id);
                        actionButton.on('click', function () {
                            detailTask(task.id,task.noiDung);
                        });
                        row.append($('<td>').append(actionButton));

                        tbody.append(row);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching needs to do tasks: " + error);
                }
            });
        }
        //
        function detailTask(IdCv,NoiDung){
            $('#ChiTietTask').modal('show');
            $('#NoiDungTask').val(NoiDung);
            console.log(IdCv);
            console.log(NoiDung);
        }

        

        // Bỏ đánh dấu tất cả các checkbox
        $('#clearCheckedAssignees').on('click', function () {
            $('.assignee-checkbox').prop('checked', false); 
        });

        // Xử lý nút hủy tất cả tệp
        $('#clearFiles').on('click', function () {
            $('#uploadedFiles').empty(); 
            $('#taskFiles').val(''); 
        });
            $('#searchAssignees').on('input', function () {
                var searchValue = $(this).val().toLowerCase();
                $('#NguoiLam .table tbody tr').each(function () {
                    var rowText = $(this).text().toLowerCase();
                    $(this).toggle(rowText.indexOf(searchValue) > -1);
                });
            });

            $('#searchInput').on('input', function () {
                var query = $(this).val().toLowerCase();

                $('#assignedByMeTableBody tr').each(function () {
                    var description = $(this).find('td').eq(1).text().toLowerCase();
                    $(this).toggle(description.includes(query));
                });

                $('#needsToDoTableBody tr').each(function () {
                    var description = $(this).find('td').eq(1).text().toLowerCase();
                    $(this).toggle(description.includes(query));
                });
            });
        
    </script>


</body>
</html>
